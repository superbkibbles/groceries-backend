# Entity ObjectID Migration Guide

This document outlines the changes needed to migrate all entity IDs from `string` to `primitive.ObjectID` for MongoDB auto-generation.

## Pattern to Follow

### 1. Import Changes
```go
// BEFORE
import (
    "github.com/google/uuid"
)

// AFTER  
import (
    "go.mongodb.org/mongo-driver/bson/primitive"
)
```

### 2. ID Field Changes
```go
// BEFORE
type Entity struct {
    ID string `json:"id" bson:"_id"`
    // other fields
}

// AFTER
type Entity struct {
    ID primitive.ObjectID `json:"id,omitempty" bson:"_id,omitempty"`
    // other fields
}
```

### 3. Reference Fields Changes
```go
// BEFORE
UserID string `json:"user_id" bson:"user_id"`

// AFTER
UserID primitive.ObjectID `json:"user_id" bson:"user_id"`
```

### 4. Constructor Changes
```go
// BEFORE
func NewEntity() *Entity {
    return &Entity{
        ID: uuid.New().String(),
        // other fields
    }
}

// AFTER
func NewEntity() *Entity {
    return &Entity{
        // ID will be auto-generated by MongoDB
        // other fields
    }
}
```

## Files Updated

âœ… **Completed:**
- `/internal/domain/entities/product.go`
- `/internal/domain/entities/user.go` 
- `/internal/domain/entities/cart.go`
- `/internal/domain/entities/category.go` (partial)

## Files Still Needing Updates

### ðŸ”„ **Entities to Update:**
1. `/internal/domain/entities/order.go`
   - Order.ID 
   - Order.CustomerID (reference to User)
   - OrderItem.ProductID (reference to Product)

2. `/internal/domain/entities/review.go`
   - Review.ID
   - Review.ProductID (reference to Product)
   - Review.UserID (reference to User)
   - Review.OrderID (reference to Order)

3. `/internal/domain/entities/notification.go`
   - Notification.ID
   - Notification.UserID (reference to User)

4. `/internal/domain/entities/wishlist.go`
   - Wishlist.ID
   - Wishlist.UserID (reference to User)
   - WishlistItem.ID
   - WishlistItem.ProductID (reference to Product)

5. `/internal/domain/entities/setting.go`
   - Setting.ID

6. `/internal/domain/entities/payment.go`
   - All payment-related entities

7. `/internal/domain/entities/shipping.go`
   - All shipping-related entities

### ðŸ”„ **Service Layer Updates:**
All services in `/internal/application/services/` need to be updated to:
- Accept `primitive.ObjectID` instead of `string` for IDs
- Use `primitive.ObjectIDFromHex()` for string-to-ObjectID conversion
- Use `.Hex()` method for ObjectID-to-string conversion when needed

### ðŸ”„ **Repository Layer Updates:**
All repositories in `/internal/adapters/repository/mongodb/` need to be updated to:
- Work with `primitive.ObjectID` types
- Update method signatures
- Update BSON queries to use ObjectID

### ðŸ”„ **Handler Layer Updates:**
All handlers in `/internal/adapters/http/rest/` need to be updated to:
- Parse ObjectID from URL parameters using `primitive.ObjectIDFromHex()`
- Handle ObjectID validation errors
- Convert between ObjectID and string for JSON responses

### ðŸ”„ **Seed Data Updates:**
`/internal/utils/seed.go` needs comprehensive updates to:
- Use ObjectID for all entity creation
- Handle ObjectID references between entities
- Update all constructor calls

## Migration Steps

### Phase 1: Complete Entity Updates
1. Finish updating all entity structs
2. Update all constructors to remove ID assignment
3. Update method signatures to use ObjectID

### Phase 2: Repository Layer
1. Update repository interfaces
2. Update MongoDB repository implementations
3. Update query builders to use ObjectID

### Phase 3: Service Layer  
1. Update service interfaces
2. Update service implementations
3. Add ObjectID validation/conversion helpers

### Phase 4: Handler Layer
1. Update request/response structures
2. Update handler method signatures  
3. Add ObjectID parsing from URL parameters
4. Update error handling for invalid ObjectIDs

### Phase 5: Seed Data
1. Update seed data generation
2. Test database initialization
3. Verify data relationships

## Helper Functions Needed

```go
// Add to a utils package
package utils

import (
    "go.mongodb.org/mongo-driver/bson/primitive"
)

// ParseObjectID safely parses a string to ObjectID
func ParseObjectID(id string) (primitive.ObjectID, error) {
    if id == "" {
        return primitive.NilObjectID, errors.New("empty ID")
    }
    return primitive.ObjectIDFromHex(id)
}

// ObjectIDToString safely converts ObjectID to string
func ObjectIDToString(id primitive.ObjectID) string {
    if id.IsZero() {
        return ""
    }
    return id.Hex()
}
```

## Testing Strategy

1. **Unit Tests**: Update all existing tests to use ObjectID
2. **Integration Tests**: Test database operations with ObjectID
3. **API Tests**: Test HTTP endpoints with ObjectID parameters
4. **Seed Tests**: Verify seed data creation and relationships

## Benefits After Migration

1. **Auto-generated IDs**: No more manual UUID generation
2. **Better Performance**: MongoDB optimized for ObjectID
3. **Consistent Format**: All IDs follow MongoDB standards
4. **Reduced Complexity**: No need to manage UUID generation
5. **Better Indexing**: Improved database performance
